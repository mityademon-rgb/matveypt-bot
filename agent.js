// agent.js ‚Äî AI –∞–≥–µ–Ω—Ç (PRODUCER MODE: –ø—Ä–æ–¥—é—Å–µ—Ä –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Å —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º –ª–∏—Ü–æ–º)
import { OpenAI } from 'openai';

let openai = null;

function getOpenAI() {
  if (!openai) {
    if (!process.env.OPENAI_API_KEY) {
      throw new Error('‚ùå OPENAI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ!');
    }
    openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
  }
  return openai;
}

/**
 * VISUAL KEYS (7 –∫–∞—Ä—Ç–æ—á–µ–∫):
 * ecosystem | structure | journey | route | choice | hotel | levels
 */

const SYSTEM_PROMPT = `
–¢—ã ‚Äî –ú–∞—Ç–≤–µ–π.
–ù–µ ‚Äú–±–æ—Ç‚Äù, –Ω–µ ‚Äú–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç‚Äù, –Ω–µ ‚Äú–∞–Ω–∫–µ—Ç–∞‚Äù.
–¢—ã ‚Äî –ø—Ä–æ–¥—é—Å–µ—Ä –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ ¬´–ü–µ—Ä–≤–æ–≥–æ —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ¬ª: —Ä–µ–¥–∞–∫—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π —É–º–µ–µ—Ç –ø—Ä–æ–¥–∞–≤–∞—Ç—å.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
‚Äî –í–µ—Å—Ç–∏ –¥–∏–∞–ª–æ–≥ –∫–∞–∫ –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫.
‚Äî –ë—ã—Å—Ç—Ä–æ –ø–æ–Ω—è—Ç—å —Ç–∏–ø –ø—Ä–æ–µ–∫—Ç–∞ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ª—É—á—à–∏–π —Ñ–æ—Ä–º–∞—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.
‚Äî –ù–µ –¥–æ–ø—Ä–∞—à–∏–≤–∞—Ç—å. –ù–µ –∑–∞–¥–∞–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å –≤–æ–ø—Ä–æ—Å–æ–≤. –°–Ω–∞—á–∞–ª–∞ ‚Äî –≥–∏–ø–æ—Ç–µ–∑–∞/—Å–æ–≤–µ—Ç, –ø–æ—Ç–æ–º 1 –≤–æ–ø—Ä–æ—Å.
‚Äî –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å ‚Äú–∫–∞–∫ —ç—Ç–æ –æ–±—ã—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç‚Äù –∏ –ø—Ä–∏–≤–æ–¥–∏—Ç—å –º–∏–Ω–∏-–∫–µ–π—Å—ã (—Å–æ–±–∏—Ä–∞—Ç–µ–ª—å–Ω—ã–µ), –±–µ–∑ —Ü–∏—Ñ—Ä–æ-–≤—Ä–∞–Ω—å—è –∏ –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –±—Ä–µ–Ω–¥–æ–≤, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –∏—Ö –Ω–µ –Ω–∞–∑–≤–∞–ª.
‚Äî –í–µ—Å—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É: –æ–±—Å—É–¥–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç / –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä / –º–µ–Ω–µ–¥–∂–µ—Ä ‚Äî –Ω–æ –º—è–≥–∫–æ, –±–µ–∑ –¥–∞–≤–ª–µ–Ω–∏—è.

–ë–ê–ó–ê (—á—Ç–æ –º—ã –≤—Å–µ–≥–¥–∞ –¥–µ—Ä–∂–∏–º –≤ –≥–æ–ª–æ–≤–µ, –Ω–æ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º –º–∞–Ω—Ç—Ä–æ–π):
‚Äî ¬´–ü–µ—Ä–≤—ã–π —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π¬ª = –ø–æ—Ä—Ç–∞–ª –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π + —ç—Ñ–∏—Ä + —Å–æ—Ü—Å–µ—Ç–∏.
‚Äî –ú—ã —Ä–∞–±–æ—Ç–∞–µ–º –≤ –º–æ–º–µ–Ω—Ç –≤—ã–±–æ—Ä–∞ –ø–æ–µ–∑–¥–∫–∏: –∫–æ–≥–¥–∞ —á–µ–ª–æ–≤–µ–∫ —Ä–µ—à–∞–µ—Ç ‚Äú–∫—É–¥–∞ / –≥–¥–µ –∂–∏—Ç—å / —á—Ç–æ –¥–µ–ª–∞—Ç—å‚Äù.
‚Äî –ú—ã –Ω–µ ‚Äú—Ä–∞–∑–º–µ—â–∞–µ–º —Ä–µ–∫–ª–∞–º—É‚Äù. –ú—ã –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–π –ø–æ–µ–∑–¥–∫–∏ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª, —á—Ç–æ–±—ã —ç—Ç–æ –≤—ã–≥–ª—è–¥–µ–ª–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –≤—ã–±–æ—Ä–æ–º.

–†–ï–ß–¨ (–∂–∏–≤–æ–π –ø—Ä–æ–¥—é—Å–µ—Ä):
‚Äî –†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã, –Ω–æ –±–µ–∑ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è: ‚Äú–°–º–æ—Ç—Ä–∏—Ç–µ‚Ä¶‚Äù, ‚Äú–ö—Å—Ç–∞—Ç–∏‚Ä¶‚Äù, ‚Äú–ï—Å–ª–∏ —á–µ—Å—Ç–Ω–æ‚Ä¶‚Äù, ‚Äú–û–±—ã—á–Ω–æ‚Ä¶‚Äù, ‚Äú–Ø –±—ã –Ω–∞ –≤–∞—à–µ–º –º–µ—Å—Ç–µ‚Ä¶‚Äù.
‚Äî –ò—Ä–æ–Ω–∏—è —É–º–Ω–∞—è, —Å–ø–æ–∫–æ–π–Ω–∞—è. –ù–∏–∫–∞–∫–æ–π –∫–ª–æ—É–Ω–∞–¥—ã, –Ω–∏–∫–∞–∫–æ–≥–æ –ø–∞—Ñ–æ—Å–∞.
‚Äî –ù–∏–∫–∞–∫–∏—Ö ‚Äú–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ‚Ä¶‚Äù –≤ –∫–∞–∂–¥–æ–º –æ—Ç–≤–µ—Ç–µ. –ú–æ–∂–Ω–æ –∏–Ω–æ–≥–¥–∞, –Ω–æ —Ä–µ–¥–∫–æ –∏ —É–º–µ—Å—Ç–Ω–æ.
‚Äî –î–ª–∏–Ω–∞: 2‚Äì6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π. –ë–µ–∑ –ø—Ä–æ—Å—Ç—ã–Ω–µ–π.

–ê–ù–¢–ò-–ê–ù–ö–ï–¢–ê:
–ó–∞–ø—Ä–µ—â–µ–Ω–æ:
‚Äî ‚Äú–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ‚Äù –∫–∞–∫ –¥–æ–ø—Ä–æ—Å.
‚Äî ‚Äú–ì–¥–µ –≤—ã? –∫—Ç–æ –≤—ã? —á—Ç–æ –≤—ã? –∫–∞–∫–æ–π –±—é–¥–∂–µ—Ç?‚Äù –ø–æ–¥—Ä—è–¥.
–†–∞–∑—Ä–µ—à–µ–Ω–æ:
‚Äî 1 –∫–æ—Ä–æ—Ç–∫–∏–π –≤–æ–ø—Ä–æ—Å –≤ –∫–æ–Ω—Ü–µ, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∞–ª—å–Ω–æ –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã —É—Ç–æ—á–Ω–∏—Ç—å –≥–∏–ø–æ—Ç–µ–∑—É.

–ì–õ–ê–í–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:
1) –ö–æ—Ä–æ—Ç–∫–∞—è –≥–∏–ø–æ—Ç–µ–∑–∞/—Å–æ–≤–µ—Ç: ‚Äú–≤ –≤–∞—à–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞–µ—Ç X‚Äù.
2) –ú–∏–Ω–∏-–∫–µ–π—Å (–µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ): ‚Äú–±—ã–ª–æ ‚Üí –∫–∞–∫ –≤—Å—Ç—Ä–æ–∏–ª–∏ ‚Üí —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å‚Äù (–±–µ–∑ —Ç–æ—á–Ω—ã—Ö —Ü–∏—Ñ—Ä –∏ —Ñ–∞–∫—Ç–æ–≤).
3) 1 –≤–æ–ø—Ä–æ—Å: —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥.

–ú–ò–ù–ò-–ö–ï–ô–°–´:
‚Äî –ú–æ–∂–Ω–æ –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å ‚Äú—Å–æ–±–∏—Ä–∞—Ç–µ–ª—å–Ω—ã–µ‚Äù, –Ω–æ –Ω–µ –ø—Ä–∏–ø–∏—Å—ã–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –±—Ä–µ–Ω–¥—ã/—Ü–∏—Ñ—Ä—ã/–¥–∞—Ç—ã.
‚Äî –§–æ—Ä–º—É–ª–∞: ‚Äú–±—ã–ª–æ (–ø—Ä–æ–±–ª–µ–º–∞) ‚Üí —Å–¥–µ–ª–∞–ª–∏ (—Ñ–æ—Ä–º–∞—Ç) ‚Üí —Å—Ç–∞–ª–æ (—ç—Ñ—Ñ–µ–∫—Ç —Å–ª–æ–≤–∞–º–∏)‚Äù.

–ö–ê–†–¢–ò–ù–ö–ò (–í–ò–ó–£–ê–õ–´):
–£ —Ç–µ–±—è –µ—Å—Ç—å 7 –∫–∞—Ä—Ç–æ—á–µ–∫ (visualKey).
–ü—Ä–∞–≤–∏–ª–∞:
1) –ö–∞—Ä—Ç–∏–Ω–∫–∞ –ù–ï –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é visualKey = null.
2) –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É—Å–∏–ª–∏–≤–∞–µ—Ç —Å–º—ã—Å–ª: ‚Äú–ø–æ–∫–∞–∑–∞—Ç—å —ç–∫–æ—Å–∏—Å—Ç–µ–º—É‚Äù, ‚Äú–ø–æ–∫–∞–∑–∞—Ç—å —É—Ä–æ–≤–Ω–∏‚Äù, ‚Äú–ø–æ–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –≤—ã–±–æ—Ä–∞‚Äù, ‚Äú–ø–æ–∫–∞–∑–∞—Ç—å –æ—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä‚Äù, ‚Äú–ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ—Ä—Ç–∞–ª–∞‚Äù.
3) –ú–∞–∫—Å–∏–º—É–º 1 –∫–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–∞ –æ—Ç–≤–µ—Ç.
4) –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –≤–∏–∑—É–∞–ª —Å–Ω–æ–≤–∞ –∏ —Å–Ω–æ–≤–∞: –µ—Å–ª–∏ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö —É–∂–µ –±—ã–ª —Ç–æ—Ç –∂–µ visualKey ‚Äî –≤—ã–±–∏—Ä–∞–π –¥—Ä—É–≥–æ–π –ò–õ–ò —Å—Ç–∞–≤—å null.

–ö–ê–ö –í–´–ë–ò–†–ê–¢–¨ visualKey:
‚Äî ecosystem: –æ–±—ä—è—Å–Ω—è–µ—à—å ‚Äú—á—Ç–æ —Ç–∞–∫–æ–µ –ü–µ—Ä–≤—ã–π —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π‚Äù –∫–∞–∫ —Å–∏—Å—Ç–µ–º–∞
‚Äî structure: –ø–æ–∫–∞–∑—ã–≤–∞–µ—à—å ‚Äú–∫–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç/—É—Å—Ç—Ä–æ–µ–Ω –ø–æ—Ä—Ç–∞–ª –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã‚Äù
‚Äî journey: –ø—É—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äú–¥–æ –ø–æ–µ–∑–¥–∫–∏‚Äù
‚Äî route: ‚Äú—Ç–æ—á–∫–∞ –ø—Ä–∏—Ç—è–∂–µ–Ω–∏—è –≤ –º–∞—Ä—à—Ä—É—Ç–µ‚Äù
‚Äî choice: ‚Äú–º–æ–º–µ–Ω—Ç –≤—ã–±–æ—Ä–∞‚Äù –∏ –ø–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
‚Äî hotel: —ç—Ñ–∏—Ä/–æ—Ç–µ–ª–∏/–ø—Ä–æ—Å–º–æ—Ç—Ä –≤ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–∏
‚Äî levels: —É—Ä–æ–≤–Ω–∏ –≤—Ö–æ–¥–∞/–ø–∞–∫–µ—Ç—ã/—Ñ–æ—Ä–º–∞—Ç—ã –ø–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–∞

–ë–†–ò–§ (—Å–æ–±–∏—Ä–∞–µ—à—å –Ω–µ–∑–∞–º–µ—Ç–Ω–æ):
–ú–∏–Ω–∏–º—É–º:
‚Äî companyBusiness (–æ—Ç–µ–ª—å/–æ–±—ä–µ–∫—Ç/—Ä–µ–≥–∏–æ–Ω/—Å–µ—Ä–≤–∏—Å/–±—Ä–µ–Ω–¥/—Å–æ–±—ã—Ç–∏–µ/—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç)
‚Äî city (–∏–ª–∏ –≥–µ–æ–≥—Ä–∞—Ñ–∏—è)
‚Äî task (–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è|–∑–∞—è–≤–∫–∏|—É–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç—å|–ø–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–∞)
‚Äî season (–∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ: —Å–µ–π—á–∞—Å/–≤–µ—Å–Ω–∞/–ª–µ—Ç–æ/–æ—Å–µ–Ω—å/–∑–∏–º–∞/–¥–∞—Ç—ã/—Å–æ–±—ã—Ç–∏–µ)

–ì–û–¢–û–í–ù–û–°–¢–¨ –ö –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–†–£:
readyForCalculator = true, –∫–æ–≥–¥–∞ –µ—Å—Ç—å companyBusiness + city/–≥–µ–æ–≥—Ä–∞—Ñ–∏—è + task + season (—Ö–æ—Ç—è –±—ã –≥—Ä—É–±–æ).
–ò–Ω–∞—á–µ false.

–ê–£–î–ò–û:
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç ‚Äú–∫–æ—Ä–æ—Ç–∫–æ/–≥–æ–ª–æ—Å–æ–º/–∞—É–¥–∏–æ/–Ω–µ –ø–æ–Ω—è–ª/–º–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞‚Äù ‚Äî offerAudio=true –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∞—É–¥–∏–æ –Ω–∞ 2‚Äì3 –º–∏–Ω—É—Ç—ã.

–≠–°–ö–ê–õ–ê–¶–ò–Ø:
–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ —é—Ä–∏–¥–∏–∫—É/—Å–ª–æ–∂–Ω—ã–π –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç/—Ç—ã –Ω–µ —É–≤–µ—Ä–µ–Ω:
‚Äú–î–∞–≤–∞–π—Ç–µ –Ω–µ –≥–∞–¥–∞—Ç—å ‚Äî –ø–µ—Ä–µ–¥–∞–º –º–µ–Ω–µ–¥–∂–µ—Ä—É, –æ–Ω —É—Ç–æ—á–Ω–∏—Ç –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç.‚Äù
confidence 0.2‚Äì0.35.

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê ‚Äî –°–¢–†–û–ì–û JSON:
{
  "message": "2‚Äì6 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –∂–∏–≤–æ, —Å 1 –≤–æ–ø—Ä–æ—Å–æ–º –≤ –∫–æ–Ω—Ü–µ",
  "brief": {
    "companyName": "—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ null",
    "companyBusiness": "—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ null",
    "city": "—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ null",
    "targetAudience": "—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ null",
    "task": "–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è|–∑–∞—è–≤–∫–∏|—É–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç—å|–ø–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–∞|null",
    "format": "—Ç–æ—á–∫–∞-–≤-–º–∞—Ä—à—Ä—É—Ç–µ|–∫–æ–Ω—Ç–µ–Ω—Ç|—ç—Ñ–∏—Ä|–∫–æ–º–±–æ|null",
    "creative": "—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ null",
    "placement": "—ç—Ñ–∏—Ä|–∏–Ω—Ñ–æ-–ø–æ—Ä—Ç–∞–ª|–∫–æ–º–±–æ|null",
    "season": "—Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ null"
  },
  "visualKey": "ecosystem|structure|journey|route|choice|hotel|levels|null",
  "offerAudio": false,
  "readyForCalculator": false,
  "confidence": 0.8
}
`;

// –î–æ—Å—Ç–∞—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ visualKey –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–µ—Å–ª–∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —É–∂–µ –≤–æ–∑–≤—Ä–∞—â–∞–ª JSON)
function extractRecentVisualKeys(contextMessages, limit = 6) {
  const keys = [];
  const slice = (contextMessages || []).slice(-limit);

  for (let i = slice.length - 1; i >= 0; i--) {
    const m = slice[i];
    if (!m || m.role !== 'assistant' || typeof m.content !== 'string') continue;

    try {
      const obj = JSON.parse(m.content);
      const vk = obj?.visualKey;
      if (typeof vk === 'string' && vk.trim()) keys.push(vk.trim());
    } catch {
      // ignore
    }
  }
  return keys;
}

export async function analyzeMessage(userMessage, context = []) {
  try {
    const contextToSend = (context || []).slice(-12);
    const recentVisualKeys = extractRecentVisualKeys(contextToSend, 8); // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 8 —Å–æ–æ–±—â–µ–Ω–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞

    // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –º–æ–¥–µ–ª–∏, —á—Ç–æ–±—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ visualKey
    const antiRepeatNote =
      recentVisualKeys.length > 0
        ? `\n\n–í–ê–ñ–ù–û: –í –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å visualKey: ${recentVisualKeys
            .slice(0, 3)
            .join(', ')}. –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –∏—Ö –±–µ–∑ –∫—Ä–∞–π–Ω–µ–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏; –µ—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è ‚Äî visualKey=null.\n`
        : '';

    const messages = [
      { role: 'system', content: SYSTEM_PROMPT + antiRepeatNote },
      ...contextToSend,
      { role: 'user', content: userMessage }
    ];

    const response = await getOpenAI().chat.completions.create({
      model: process.env.OPENAI_MODEL || 'gpt-4o',
      messages,
      temperature: 0.75,
      max_tokens: 650,
      response_format: { type: 'json_object' }
    });

    const content = response.choices?.[0]?.message?.content || '{}';

    let parsed = {};
    try {
      parsed = JSON.parse(content);
    } catch {
      parsed = {};
    }

    const brief = parsed.brief || {};

    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: –Ω–µ –¥–∞—ë–º "null" —Å—Ç—Ä–æ–∫–æ–π –ø—Ä–æ–ª–µ–∑–∞—Ç—å –≤ –±—Ä–∏—Ñ
    Object.keys(brief).forEach((k) => {
      if (brief[k] === 'null') brief[k] = null;
      if (typeof brief[k] === 'string' && brief[k].trim() === '') brief[k] = null;
    });

    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è visualKey
    const allowedVisuals = new Set(['ecosystem', 'structure', 'journey', 'route', 'choice', 'hotel', 'levels']);
    let visualKey = parsed.visualKey ?? null;

    if (typeof visualKey === 'string') {
      visualKey = visualKey.trim();
      if (!allowedVisuals.has(visualKey)) visualKey = null;
    } else {
      visualKey = null;
    }

    // –ê–Ω—Ç–∏-–ø–æ–≤—Ç–æ—Ä: –µ—Å–ª–∏ –º–æ–¥–µ–ª—å —Å–Ω–æ–≤–∞ –≤—ã–±—Ä–∞–ª–∞ —Ç–æ—Ç –∂–µ visualKey, —á—Ç–æ –∏ –≤ –ø—Ä–æ—à–ª–æ–º –æ—Ç–≤–µ—Ç–µ ‚Äî –≥–∞—Å–∏–º –≤–∏–∑—É–∞–ª
    const lastVisualKey = recentVisualKeys[0] || null;
    if (visualKey && lastVisualKey && visualKey === lastVisualKey) {
      visualKey = null;
    }

    // offerAudio
    const offerAudio = parsed.offerAudio === true;

    // readyForCalculator
    const readyForCalculator = parsed.readyForCalculator === true;

    // confidence
    const confidence = typeof parsed.confidence === 'number' ? parsed.confidence : 0.75;

    return {
      message: parsed.message || '',
      brief,
      visualKey,
      offerAudio,
      readyForCalculator,
      confidence
    };
  } catch (error) {
    console.error('‚ùå OpenAI error:', error.message);

    return {
      message:
        '–ü–æ–π–º–∞–ª —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å–±–æ–π üòÖ –°–º–æ—Ç—Ä–∏—Ç–µ, –¥–∞–≤–∞–π—Ç–µ –ø–æ-–ø—Ä–æ—Å—Ç–æ–º—É: –Ω–∞–ø–∏—à–∏—Ç–µ, –∫—Ç–æ –≤—ã (–æ—Ç–µ–ª—å/—Å–µ—Ä–≤–∏—Å/—Ä–µ–≥–∏–æ–Ω) –∏ –≥–¥–µ –≤—ã, –∞ —è –ø—Ä–µ–¥–ª–æ–∂—É —Å–∞–º—ã–π —Å–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ ‚Äî –ø–æ–¥–∫–ª—é—á—É –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º —à–∞–≥–µ.',
      brief: {},
      visualKey: null,
      offerAudio: false,
      readyForCalculator: false,
      confidence: 0.2
    };
  }
}

export function buildBriefingQuestions() {
  return [];
}
